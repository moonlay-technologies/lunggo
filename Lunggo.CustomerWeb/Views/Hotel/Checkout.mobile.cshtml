@using System.Globalization
@using Lunggo.ApCommon.Hotel.Model
@using Lunggo.ApCommon.Hotel.Service
@using Lunggo.Framework.Context
@using Lunggo.Framework.Extension
@using Microsoft.Ajax.Utilities
@model Lunggo.CustomerWeb.Models.HotelCheckoutData
 
@{
    Layout = "/Views/Shared/mobile/_Layout.cshtml";
    ViewBag.BodyClass = "page-hotel page page-checkout";
    ViewBag.AngularController = "hotelcheckoutController";
    ViewBag.SiteHeader = "checkout";
    ViewBag.Title = "Checkout";
}
@{
    var rooms = new List<HotelRoomForDisplay>();
    var token = "";
    Model.HotelDetail.MainImage = "http://photos.hotelbeds.com/giata/" + Model.HotelDetail.MainImage;
    var night = (Model.HotelDetail.CheckOutDate - Model.HotelDetail.CheckInDate).Days;
    var roomImage = "";
    var sumAdult = 0;
    var sumChild = 0;
    var textInfo = new CultureInfo("en-US", false).TextInfo;
    var orderedRooms = new List<Tuple<string, int>>();
    var listAges = new List<int>();
    var hotelMainImage = "http://photos.hotelbeds.com/giata/" + Model.HotelDetail.MainImage;
    
    try
    {

        if (Model.HotelDetail.ImageUrl != null && Model.HotelDetail.ImageUrl.Count != 0)
        {
            roomImage = "http://photos.hotelbeds.com/giata/" + Model.HotelDetail.ImageUrl.FirstOrDefault();
        }
        rooms = Model.HotelDetail.Rooms;
        token = Model.Token;
        foreach (var room in rooms)
        {
            var roomName = room.RoomName;
            var sum = 0;
            foreach (var rate in room.Rates)
            {
                sum += rate.RoomCount;
                sumAdult += rate.AdultCount;
                sumChild += rate.ChildCount;
                if (rate.ChildCount <= 0)
                {
                    continue;
                }
                listAges.AddRange(rate.ChildrenAges);
            }
            orderedRooms.Add(new Tuple<string, int>(roomName, sum)); ;
        }

    }
    catch
    {
        ViewBag.Message = "BookExpired";
    }

}
@functions{

    public string ToTitleCase(string input)
    {

        var text = "";
        try
        {
            var splittedText = input.Split(' ');
            foreach (var word in splittedText)
            {
                var splittedByStrips = word.Split('-');
                var w = "";
                if (splittedByStrips.Count() != 1)
                {
                    foreach (var part in splittedByStrips)
                    {
                        w += ApplyTitleCase(part) + "-";
                    }
                    text += w.Substring(0, w.Length - 1) + " ";
                }
                else
                {
                    text += word[0] + word.Substring(1, word.Length - 1).ToLower() + " ";
                }
            }

        }
        catch
        {

        }
        return text.Length == 0 ? "" : text.Substring(0, text.Length - 1);
    }


    public string ApplyTitleCase(string input)
    {
        return input[0] + input.Substring(1, input.Length - 1).ToLower();
    }

}

@section AdditionalCSS {
    <link href="/Assets/css/jquery-ui.min.css" rel="stylesheet" />
    <!-- fancybox CSS-->
    <link href="/Assets/vendor/fancybox/jquery.fancybox.css" rel="stylesheet" />
}

@section AdditionalJS {
    <!-- additional Angular JS-->
    <script src="/Assets/js/angular.min.js"></script>
    <script src="/Assets/js/angular-animate.min.js"></script>
    <script src="/Assets/js/angular-route.min.js"></script>
    <script src="/Assets/js/jquery.countdown.min.js"></script>
    <script src="/Assets/js/CryptoJS/components/core-min.js"></script>
    <script src="/Assets/js/CryptoJS/rollups/sha512.js"></script>
    <script src="/Assets/js/CryptoJS/components/enc-base64-min.js"></script>
    <!-- veritrans JS -->
    <script src="https://api.sandbox.veritrans.co.id/v2/assets/js/veritrans.min.js"></script>
    <!-- fancybox -->
    <script type="text/javascript" src="/Assets/vendor/fancybox/jquery.fancybox.pack.js"></script>
}

@section PageJS{
    <!-- angular controller -->
    <script>
    var langCode = '@OnlineContext.GetActiveLanguageCode()';
    var hotelDetail = @Html.Raw(Model.HotelDetail.Serialize());
    var expirytime = '@Model.ExpiryTime.ToString("o")';
    var originalFare = '@Model.HotelDetail.OriginalFare';
    var netFare = '@Model.HotelDetail.NetFare';
    var totalRoom = '@Model.HotelDetail.Rooms.SelectMany(r => r.Rates).Sum(p => p.RoomCount)';
    var checkin = '@Model.HotelDetail.CheckInDate.ToString("D",CultureInfo.CreateSpecificCulture("id-ID"))';
    var checkout = '@Model.HotelDetail.CheckOutDate.ToString("D", CultureInfo.CreateSpecificCulture("id-ID"))';
    var nights = '@((Model.HotelDetail.CheckOutDate - Model.HotelDetail.CheckInDate).Days)';
    var country = '@Model.HotelDetail.CountryName';

    if (getParam('page') == 2) {
        currentPage = getParam('page');
    } else {
        currentPage = 1;
    }
    var token = '@Model.Token';
    var hotelImg = '@hotelMainImage';
    </script>
    <script src="/Assets/travorama20/js/HotelCheckoutController.js"></script>
    <script src="/Assets/travorama20/angularDirectory/search/hotelSearch.service.js"></script>
    @*<script src="/Assets/mobile/js/HotelController.js"></script>*@
}

<header class="page__header">
    <div class="step__wrapper">
        <div class="step step-1" style = "width: 50%" ng-class="{'active' : currentPage == 1, 'inactive' : currentPage > 1}"><span class=" xlg-txt">01</span></div>
        <div class="step step-2" style="width: 50%" ng-class="{'active' : currentPage == 2, 'inactive' : currentPage > 2}"><span class="xlg-txt">02</span></div>
        
    </div>
</header>
<section class="checkout-content">
    <div class=" page-step-1" ng-show="currentPage == 1">
        <div class="form-hotel">
            <h3><b>DATA</b> PEMESAN</h3>
            <form name="BuyerForm" novalidate>
                <div class="form-group">
                    <label class="control-label">Titel : </label>
                    <select class="form-control" name="title" ng-model="buyerInfo.title" ng-init="buyerInfo.title = titles[0].value">
                        <option ng-repeat="title in titles" value="{{title.value}}">{{title.name}}</option>
                    </select>
                </div>
                <div class="form-group important">
                    <label class="control-label">Nama Lengkap<span class="imp"></span> : </label>
                    <input type="text" value="" @*pattern="[a-zA-Z\s]+"*@ ng-model="buyerInfo.name" name="name" class="form-control nama" placeholder="Nama Lengkap" required />
                    <div ng-show="!checkName(buyerInfo.name)" style="color:red">
                        Nama tidak boleh mengandung karakter selain alfabet dan spasi
                    </div>
                </div>
                
                <div class="form-group important">
                    <label class="control-label">Nomor Telepon<span class="imp"></span> : </label>
                    <div class="row">
                        <div class="col-xs-12 bottom-divider">
                            <p><small>Kode Negara</small></p>
                            <select class="form-control" name="PhoneCode" ng-model="buyerInfo.countryCode" ng-init="buyerInfo.countryCode = '62'">
                                <option ng-repeat="country in countries" ng-selected="country.dial_code == buyerInfo.countryCode" value="{{country.dial_code}}">{{country.name}} ({{country.dial_code}})</option>
                            </select>
                            @*<input type="number" value="" ng-model="buyerInfo.countryCode" name="PhoneCode" class="form-control" placeholder="Ex : 62 for Indonesia" required />*@
                        </div>
                        <div class="col-xs-12">
                            <p><small>Nomor Telepon (Tanpa Kode Negara)</small></p>
                            <input type="number" value="" ng-model="buyerInfo.phone" name="Phone" class="form-control" placeholder="Ex : 821 2345 6789" required />
                        </div>
                    </div>
                </div>
                <div class="form-group important" ng-class="{'has-error' : BuyerForm.email.$touched && BuyerForm.email.$invalid}">
                    <label class=" control-label">Masukkan alamat e-mail Anda<span class="imp"></span> : </label>
                    <input type="email" value="" ng-model="buyerInfo.email" name="Email" class="form-control" placeholder="Ex: name@domain.com" required />
                </div>
                @*<div class="form-group">
                    <div class="form-box">
                        <div class="fb-header"><b>Kamar</b> : Deluxe 2 Kings Bed Rooms</div>
                        <div class="fb-body">
                            <div class="fb-top">Tamu per Kamar : <b>4 Orang</b></div>
                            <div class="fb-bottom">
                    <div class="form-group">
                        <label class="control-label">Titel : </label>
                                    <select class="form-control" name="title" ng-model="buyerInfo.title" ng-init="buyerInfo.title = titles[0].value">
                            <option ng-repeat="title in titles" value="{{title.value}}">{{title.name}}</option>
                        </select>
                    </div>
                    <div class="form-group important">
                                    <label class="control-label">Nama Lengkap Tamu : </label>
                                    <input type="text" value="" pattern="[a-zA-Z\s]+" ng-model="buyerInfo.name" name="name" class="form-control nama" placeholder="Nama Lengkap" required />
                        </div>
                                <div class="fb-note">
                                    <div>Catatan Khusus:</div>
                                    <ul class="sqr-blue-list md-txt">
                                        <li>
                                            <div class="blue-txt semibold-txt">Room Policy</div>
                                            <div class="grey-txt">Lorem ipsum dolor sit amet.</div>
                                        </li>
                                        <li>
                                            <div class="blue-txt semibold-txt">Room Policy</div>
                                            <div class="grey-txt">Lorem ipsum dolor sit amet.</div>
                                        </li>
                                    </ul>
                    </div>
                </div>
                </div>
                    </div>
                </div>*@
                <input type="checkbox" name="diffPerson" ng-model="diffPerson" value="false" ng-change="cleanGuestInfo()"> Saya membuat reservasi untuk orang lain.<br>
                <div ng-show ="diffPerson">
                    <h3><b>DATA</b> TAMU</h3>
                    <div class="form-group">
                        <label class="control-label">Titel : </label>
                        <select class="form-control" name="title" ng-model="guestInfo.title" ng-init="guestInfo.title = titles[0].value">
                            <option ng-repeat="title in titles" value="{{title.value}}">{{title.name}}</option>
                        </select>
                    </div>
                    <div class="form-group important">
                        <label class="control-label">Nama Lengkap<span class="imp"></span> : </label>
                        <input type="text" value="" @*pattern="[a-zA-Z\s]+"*@ ng-model="guestInfo.name" name="name" class="form-control nama" placeholder="Nama Lengkap" required />
                        <div ng-show="!checkName(guestInfo.name)" style="color:red">
                            Nama tidak boleh mengandung karakter selain alfabet dan spasi
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-box">
                        <div class="fb-header"><b>Permintaan Khusus</b> (opsional)</div>
                        <div class="fb-body">
                            <textarea name="fb-request" placeholder="Silakan tulis permintaan khusus Anda di sini" ng-model="buyerInfo.message"></textarea>
                            @*<div class="fb-bed clearfix">
                        Your Bed Preference (if available):
                        <label class="checkbox">
                            <div class="switch"></div>
                            <span class="md-txt os-regular title">2 extra-large doubles <span class="double-bed"></span></span>
                            <input type="checkbox" name="check" class="check" value="false">
                        </label>
                        <label class="checkbox">
                            <div class="switch"></div>
                            <span class="md-txt os-regular title">2 singles <span class="single-bed"></span><span class="single-bed"></span>, 1 extra-large double <span class="double-bed"></span></span>
                            <input type="checkbox" name="check" class="check" value="false">
                        </label>
                    </div>
                    <div class="fb-est md-txt">
                        <p>Your estimated time of arrival</p>
                        <div class="bold-txt">24 hour reception:</div>
                        <div>You can arrive any time you like - <br /> your room will be ready <b>at 15:00</b></div>
                    </div>*@
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div style="color:red" ng-show="form.incompleteContactTitle">
                        Gelar pada Nama Pemesan Belum Ditambahkan <br /> <br />
                    </div>
                    <div style="color:red" ng-show="form.incompleteContactName">
                        Nama pada Data Pemesan Belum Ditambahkan <br /> <br />
                    </div>
                    <div style="color:red" ng-show="form.incompleteContactPhone">
                        Nomor Telepon pada Data Pemesan Belum Lengkap. Silakan Pilih Kode Negara atau Lengkapi Nomor Telepon<br /> <br />
                    </div>
                    <div style="color:red" ng-show="form.incompleteContactEmail">
                        Alamat E-Mail pada Data Pemesan Belum Ditambahkan<br /> <br />
                    </div>
                    <div style="color:red" ng-show="form.incompleteGuestTitle">
                        Gelar pada Nama Tamu Belum Ditambahkan <br /> <br />
                    </div>
                    <div style="color:red" ng-show="form.incompleteGuestName">
                        Nama pada Data Tamu Belum Ditambahkan <br /> <br />
                    </div>
                    <button class="btn btn-yellow form-control" ng-click="validateForm(1)" ng-disabled="BuyerForm.$invalid || buyerInfo.title == titles[0].value">LANJUT</button>
                </div>
            </form>
        </div>
    </div>
    <div class=" page-step-2" ng-show="currentPage == 2" @*style="display: none;"*@>
        <div class="review-hotel">
            <h3 class="summary__title"><b>REVIEW</b> PESANAN</h3>
            <div class="form-group">
                <div class="form-box">
                    <div class="fb-hotel">
                        <div class="fb-header"><b>Detail Hotel</b></div>
                        <div class="fb-body">
                            @Html.Partial("/Views/Hotel/Shared/Mobile/_HotelDetail.cshtml", Model.HotelDetail)
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-box">
                    <div class="fb-header"><b>Detail Kamar</b></div>
                    <div class="fb-body">
                        @foreach (var room in rooms)
                        {
                            foreach (var rate in room.Rates)
                            {
                                <div class="fb-room">
                                    <div class="clearfix">
                                        <div class="col-8"><div class="blue-txt bold-txt lg-txt">@ToTitleCase(room.RoomName) @ToTitleCase(rate.BoardDescription)</div></div>
                                        @*<div class="col-2"><span class="meal-icon pull-right"></span><span class="wifi-icon pull-right"></span></div>*@
                                    </div>
                                    <div class="fb-img" style="background-image: url(@roomImage)"></div>
                                    <div class="clearfix">
                                        <div class="fb-row clearfix">
                                            <div class="col-6">Jumlah Kamar</div>
                                            <div class="col-4 bold-txt">@rate.RoomCount Kamar</div>
                                        </div>
                                        <div class="fb-row clearfix">
                                            <div class="col-6">Tamu per Kamar</div>
                                            <div class="col-4 bold-txt">@rate.AdultCount Dewasa @if (rate.ChildCount > 0)
                                                                                                {
                                                                                                    <span>, @rate.ChildCount Anak</span>
                                                                                                }
                                            </div>
                                        </div>
                                        @if (rate.ChildCount > 0)
                                        {
                                            <div class="fb-row clearfix">
                                                <div class="col-6">Umur Anak</div>
                                                <div class="col-4 bold-txt">
                                                    <span>
                                                        @for (var a = 0; a < listAges.Count; a++)
                                                        {
                                                            if (a != listAges.Count - 1)
                                                            {
                                                                @listAges[a]
                                                                <span>Tahun, </span>
                                                            }
                                                            else
                                                            {
                                                                @listAges[a] <span>Tahun</span>
                                                            }
                                                        }
                                                    </span>
                                                </div>
                                            </div>
                                        }
                                        
                                    </div>
                                    <ul class="blue-list blue-txt">
                                        <li ng-show="room.rate.isFreeCancel">
                                            Gratis pembatalan sebelum 
                                            <span style="color:#1daee4">
                                                @rate.FreeUntil.GetValueOrDefault().ToString("D", CultureInfo.CreateSpecificCulture("id-ID"))'
                                            </span> WIB.
                                        </li>
                                        @foreach (var cancellation in rate.Cancellation)
                                        {
                                            <li >
                                                Pembatalan setelah <span style="color:#1daee4">@cancellation.StartTime.ToString("D", CultureInfo.CreateSpecificCulture("id-ID"))</span>
                                                akan dikenakan biaya pembatalan sebesar <span style="color:#ff7200">Rp @cancellation.SingleFee.ToString("##,###", CultureInfo.CreateSpecificCulture("id-ID"))</span> per kamar.
                                            </li>
                                        }
                                        
                                    </ul>
                                    <div class="fb-note">
                                        <div>Catatan Khusus:</div>
                                        <ul class="sqr-blue-list">
                                            
                                            @foreach (var tnc in rate.TermAndCondition)
                                            {
                                                <li>
                                                    <div class="blue-txt semibold-txt">Ketentuan Kamar</div>
                                                    <div class="grey-txt">@tnc</div>
                                                </li>
                                            }
                                            
                                        </ul>
                                    </div>
                                </div>
                            }

                        }
                        
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-box">
                    <div class="fb-header"><b>Detail Pemesan</b></div>
                    <div class="fb-body">
                        <div class="clearfix">
                            <div class="fb-row clearfix">
                                <div>Pemesan</div>
                                <div class="bold-txt" style="padding-bottom: 5px">{{changeTitle(buyerInfo.title)}} {{buyerInfo.name}}</div>
                            </div>
                            <div class="fb-row clearfix">
                                <div>E-Mail</div>
                                <div class="bold-txt" style="padding-bottom: 5px">{{buyerInfo.email}}</div>
                            </div>
                            <div class="fb-row clearfix">
                                <div>No. Telepon</div>
                                <div class="bold-txt" style="padding-bottom: 5px">+{{buyerInfo.countryCode}}{{buyerInfo.phone}}</div>
                            </div>
                            <div class="fb-row clearfix">
                                <div>Tamu</div>
                                <div class="bold-txt" style="padding-bottom: 5px">{{changeTitle(guestInfo.title)}} {{guestInfo.name}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @Html.Partial("/Views/Hotel/Shared/Mobile/_PriceDetail.cshtml", Model.HotelDetail)
            <div class="tnc-box italic-txt">
                *Harga ini masih bisa berubah, harga final maskapai akan dikonfirmasi kembali pada proses pembayaran
            </div>
            <form action="" method="post" name="submitForm" id="rsvno" class="hidden">
                <input type="text" name="RsvNo" value="" id="rsvno-input" />
            </form>
            <div class="form-group">
                <button class="btn btn-grey form-control" ng-click="changePage(1)">KEMBALI</button>
                <button class="btn btn-yellow form-control" ng-disabled="book.booking" ng-click="book.send()">PESAN</button>
            </div>
        </div>
    </div>
    <div class="popup__wrapper" ng-class="{'active': book.isPriceChanged}">
        <div class="popup">
            <header class="popup__header">
                <h4 class="popup__title">Harga Berubah</h4>
            </header>
            <div class="popup__body price-change-body">
                <div class="container_new">
                    <span>Harga tiket ini berubah menjadi Rp {{book.newPrice | number : fractionSize}} disebabkan perubahan harga dari maskapai.</span>
                </div>
            </div>
            <div class="popup__footer">
                <div class="container_new price-change-footer">
                    <div class="row">
                        <div class="col-xs-12">
                            <form name="finalForm" id="finalForm" ng-submit="book.checkCreditCard()" class="ng-pristine ng-valid">
                                <input type="submit" class="btn btn-yellow" value="PESAN PENERBANGAN INI">
                            </form>
                        </div>
                        <div class="col-xs-12">
                            <a class="btn btn-grey btn-block" href="{{returnUrl}}">KEMBALI</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popup__wrapper" ng-class="{'active': expired}">
        <div class="popup">
            <header class="popup__header">
                <h4 class="popup__title">Checkout Kadaluarsa</h4>
            </header>
            <div class="popup__body">
                <div class="container_new">
                    <span>Maaf, waktu checkout Anda sudah habis. Silakan klik tombol dibawah untuk kembali ke halaman pencarian.</span>
                </div>
            </div>
            <div class="popup__footer">
                <div class="container_new">
                    <a class="btn btn-block btn-yellow" href="{{returnUrl}}">KEMBALI</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="popup__wrapper" ng-class="{'active': book.checked && book.isSuccess}">
        <div class="popup">
            <header class="popup__header">
                <h4 class="popup__title">Pemesanan Berhasil</h4>
            </header>
            <div class="popup__body">
                <div class="container_new">
                    <span>Hotel Tersedia. Mengalihkan Anda ke halaman pembayaran.</span>
                </div>
            </div>
        </div>
    </div>

    <div class="popup__wrapper" ng-class="{'active': book.checked && !book.isSuccess}">
        <div class="popup">
            <header class="popup__header">
                <h4 class="popup__title">Pemesanan Gagal</h4>
            </header>
            <div class="popup__body">
                <div class="container_new">
                    <span>Mohon Maaf, pemesanan Anda gagal di proses.</span>
                </div>
            </div>
            <div class="popup__footer">
                <div class="container_new">
                    <a class="btn btn-block btn-yellow" href="{{returnUrl}}">KEMBALI</a>
                </div>
            </div>
        </div>
    </div>

    <div class="popup__wrapper" ng-class="{'active': book.booking}">
        <div class="popup">
            <header class="popup__header">
                <h4 class="popup__title">Mohon Tunggu</h4>
            </header>
            <div class="popup__body">
                <div class="container_new">
                    <span>Sedang memproses pemesanan Anda ke pihak hotel. Proses ini dapat berlangsung hingga 5 (lima) menit.</span>
                </div>
            </div>
        </div>
    </div>

    <div class="popup__wrapper" ng-class="{'active': book.isPriceChanged}">
        <div class="popup">
            <header class="popup__header">
                <h4 class="popup__title">Harga Berubah</h4>
            </header>
            <div class="popup__body price-change-body">
                <div class="container_new">
                    <span>Harga tiket ini berubah menjadi Rp {{book.newPrice}} disebabkan perubahan harga dari pihak hotel.</span>
                </div>
            </div>
            <div class="popup__footer">
                <div class="container_new price-change-footer">
                    <div class="row">
                        <div class="col-xs-12">
                            <form name="finalForm" id="finalForm" ng-submit="book.checkCreditCard()" class="ng-pristine ng-valid">
                                <input type="submit" class="btn btn-yellow" value="PESAN HOTEL INI">
                            </form>
                        </div>
                        <div class="col-xs-12">
                            <a class="btn btn-grey btn-block" href="{{PageConfig.ReturnUrl}}">KEMBALI</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>